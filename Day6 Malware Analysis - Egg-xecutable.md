# Malware Analysis - Egg-xecutable
Discover some common tooling for malware analysis within a sandbox environment.

## Learning Objectives
- The principles of malware analysis
- An introduction to sandboxes
- Static vs. dynamic analysis
- Tools of the trade: PeStudio, ProcMon, Regshot

---

# Principles of Malware Analysis

Malware analysis is the process of examining a malicious file to understand its functionality, operation, and methods for defence against it.
By analysing a malicious file or application, we can see exactly how it operates, and therefore, know how to prevent it.
Instead of fearing malware, we can take a proactive approach by translating technical findings into practical defensive measures and understanding how the malware fits into an attacker's techniques.

There are two main branches of malware analysis: static and dynamic.
**Static analysis** focuses on inspecting a file without executing it, whereas **dynamic analysis** involves execution.

**Static Analysis:** The process of analyzing malware without executing it, but in a controlled environment.

**Dynamic Analysis:** The process of analyzing malware by running it in a controlled environment like a sandbox.

---

# Sandboxes

In cyber security, sandboxes are used to execute potentially dangerous code.
These sandboxes are safe, isolated environments where potentially malicious applications can perform their actions without risking sensitive data or impacting other systems.

> The use of sandboxes is part of the golden rule in malware analysis: **never run dangerous applications on devices you care about.**

Most of the time, sandboxes present themselves as virtual machines. Virtual machines are a popular choice for sandboxing because you can control how the system operates and benefit from features such as snapshotting, which allows you to create and restore the machine to various stages of its status. 

---

# Interactive: Static Analysis

We use static analysis to gather information about a sample without executing it and digging deep.  

Static analysis can be a quick and effective way to understand how the sample may operate, as well as how it can be identified.

Some of the information that can be gathered from static analysis has been included in the table below:

|Information|Explanation|Example|
|-----------|------------|--------|
|Checksums|These checksums are used within cyber security to track and catalogue files and executables. For example, you can Google the checksum to see if this has been identified before.|`a93f7e8c4d21b19f2e12f09a5c33e48a`|
|Strings|"Strings" are sequences of readable characters within an executable. This could be, for example, IP addresses, URLs, commands, or even passwords!|`138.62.51.186`|
|Imports|"Imports" are a list of libraries and functions that the application depends upon. For example, rather than building everything from scratch, applications will use operating system functions and libraries to interact with the OS. These are useful, especially in Windows, as they allow you to see how the application interacts with the system.|`CreateFileW` This library is used to create a file on a Windows system.|
|Resources|"Resources" contain data such as the icon that is displayed to the user. This is useful to examine, especially since malware might use a Word document icon to trick the user. Additionally, malware itself has been known to hide in this section!|N/A|

Attackers hide how a file really works using techniques like obfuscation so that antivirus software and security analysts cannot easily understand or detect it.

---

## Demonstrating PeStudio

First, we will use PeStudio to gather information about the executable.

1. Launch PeStudio
2. Load the executable into PeStudio
3. Click on the "indicators" tab in the dropdown
4. Look for the SHA256Sum

<img width="1090" height="617" alt="image" src="https://github.com/user-attachments/assets/7fc3c840-39da-445e-888a-ff719a8c3a9d" />

Next, we will proceed with reviewing the "Strings" of the executable.
In the context of malware analysis, strings are sequences of readable characters present within an executable. This could be, for example, IP addresses, URLs, commands, or even passwords! As a malware analyst, it's great to have a look at these, as these could reveal the attacker's command infrastructure, which we can use for our defences.

<img width="938" height="552" alt="image" src="https://github.com/user-attachments/assets/5fc8321f-8b44-43ab-b0be-39e85c9d9302" />

---

# Interactive: Dynamic Analysis

Dynamic analysis involves executing the malicious sample to identify its behaviours and how it interacts with the operating system.

## Regshot

Regshot is a widely used utility, especially when analysing malware on Windows.
It works by creating two "snapshots" of the registryâ€”one before the malware is run and another afterwards.
The results are then compared to identify any changes.
Malware aims to establish persistence, meaning it seeks to run as soon as the device is switched on.
A common technique for malware is to add a Run key into the registry, which is frequently used to specify which applications are automatically executed when the device is powered on.

## ProcMon

Proccess Monitor is used to monitor and investigate how processes are interacting with the Windows operating system.
It is a powerful tool that allows us to see exactly what a process is doing.
For example, reading and writing registry keys, searching for files, or creating network connections.
Process Monitor will automatically start capturing events of various processes on the system.
After allowing a minute to pass, ensuring the sample has fully executed, we will now stop capturing. To stop capturing more events, click on the Play button in the toolbar of Process Monitor.
Click on the Filter button, and then Filter within the dropdown to apply some filters.

We can create some filters to remove some of the noise that we don't care about. we can apply a filter like:

1. Apply the Process Name filter
2. Set the condition to is
3. Put in the name of the process we wish to see within the text area
4. Press the Add button to apply this filter
5. And finally click OK to save.

Once done, returning to the main Process Monitor window, we can already see the filter has worked.
Now it is much easier to investigate how the process is interacting with the operating system.

Here are some Operations that may be of interest to us:
- RegOpenKey
- CreateFile
- TCP Connect
- TCP Recieve

However, as you can see, there is still a lot of information. We can further apply filters to look for specific things that we want to investigate, such as these aforementioned Operations.

To do so, return to the Filter heading and create the filter we want to apply. For example, we can filter by Operations. Let's do so below, filtering for any TCP Operation:

<img width="777" height="473" alt="image" src="https://github.com/user-attachments/assets/5198a264-cd43-488c-b50d-1c98d81e16de" />

We will now see all Operations that include TCP. Remember, you can remove the filters you've previously applied by pressing the filter in the Filter list, and pressing Remove:

<img width="777" height="476" alt="image" src="https://github.com/user-attachments/assets/fe0e543c-cfb5-485d-948f-f27f2efdaf14" />

Or, alternatively, if you wish to start over, you can simply press the Reset Filter option when clicking on the Filter heading.

<img width="562" height="357" alt="image" src="https://github.com/user-attachments/assets/34d39128-8177-4a38-ba2a-0b7bae6703b4" />
